# 分布式缓存

## 开篇

一级缓存是应用内缓存，二级缓存是比一级缓存更大的一个容器，它是应用集群获取缓存数据的统一载体。

二级缓存存在的意义就是如果二级缓存中有数据，集群中任一节点在本地缓存中没获取到数据的时候可以从二级缓存中直接获取到数据而不用查询数据库。

**总结**：进程内缓存做为一级缓存，分布式缓存做为二级缓存，首先从一级缓存中查询，若能查询到数据则直接返回，

否则从二级缓存中查询，若二级缓存中可以查询到数据，则回填到一级缓存中，并返回数据。

若二级缓存也查询不到，则从数据源中查询，将结果分别回填到一级缓存，二级缓存中。

## 缓存的有界和无界

有界的缓存我们可以留下更多的空间和资源给服务器，让其处理的更快，因此我们需要使我们的缓存变成有界的。

我们需要提供一些驱逐策略来使缓存占用的空间在一个合理的范围内

## 多个应用使用统一的可视化程序进行管理

假设我们有用户系统，有订单系统... 这些系统都是集群模式，我们需要使用一个统一的可视化程序进行管理这些系统的缓存

1. 可以通过该程序手动清除某个系统的某个缓存
2. 可以查看各个系统的缓存的命中率... 参数
3. ...

## 架构设计

### 思考

1. 前几天在准备做二级缓存的时候，就在想如果一级缓存里面有数据，还要二级缓存干啥？ 首先为什么要用缓存？

不就是因为我们数据库压力太大了嘛，查询太慢了嘛，好办！我们给他加个缓存，为了尽量减轻服务器内存的压力，我们可以先加一个 redis 缓存，后来发现请求全跑到 redis 上了，

redis 压力也很大， redis 也快扛不住了，我们为了减轻 redis 的压力，这个时候没办法了，我们必须要加一个本地缓存，占用服务器的一部分内存来做缓存，来减轻 redis 的压力，即一部分数据走本地缓存，一部分数据走 redis 缓存

分流思想。

因此，我们的就设计了这样一个二级缓存结构： 

第一级缓存是：Caffeine , 第二级缓存是：Redisson。

二级缓存，我们使用Redisson对Spring Cache的扩展类RedissonCache 。它的底层是RMap，底层存储是Hash。

2. 考虑一二级缓存的配置是否要一致


**「查询」数据的流程**：

先从本地缓存中查询数据，若能查询到，直接返回；

本地缓存查询不到数据，查询分布式缓存，若可以查询出来，回填到本地缓存，并返回；

若分布式缓存查询不到数据，则默认会执行被注解的方法。


## 二级缓存需要考虑的点还很多

### 1.如何保证分布式节点一级缓存的一致性？

我们说一级缓存是应用内缓存，那么当你的项目部署在多个节点的时候，如何保证当你对某个key进行修改删除操作时，使其它节点的一级缓存一致呢？

### 2.是否允许存储空值？

这个确实是需要考虑的点。因为如果某个查询缓存和数据库中都没有，那么就会导致频繁查询数据库，导致数据库Down,这也是我们常说的缓存穿透。

但如果存储空值呢，因为可能会存储大量的空值，导致缓存变大，所以这个最好是可配置，按照业务来决定是否开启。

### 3.是否需要缓存预热？

也就是说，我们会觉得某些key一开始就会非常的热，也就是热点数据，那么我们是否可以一开始就先存储到缓存中，避免缓存击穿。

### 4.一级缓存存储数量上限的考虑？

既然一级缓存是应用内缓存，那你是否考虑一级缓存存储的数据给个限定最大值，避免存储太多的一级缓存导致OOM。

### 5.一级缓存过期策略的考虑？

我们说redis作为二级缓存，redis是淘汰策略来管理的。具体可参考redis的8种淘汰策略。那你的一级缓存策略呢？就好比你设置一级缓存

数量最大为5000个,那当第5001个进来的时候，你是怎么处理呢？是直接不保存，还是说自定义LRU或者LFU算法去淘汰之前的数据？

### 6.一级缓存过期了如何清除？

我们说redis作为二级缓存，我们有它的缓存过期策略(定时、定期、惰性)，那你的一级缓存呢，过期如何清除呢？

这里4、5、6小点如果说用我们传统的Map显然实现是很费劲的，但现在有更好用的一级缓存库那就是Caffeine。

### 7. 缓存 item和缓存list的时候，更希望取列表时按item缓存

缓存 item和缓存list的时候，更希望取列表时按item缓存，因为可能列表和详情的字段内容是一样的，列表和详情在内存上重复了，造成了内存的浪费


https://www.cnblogs.com/makemylife/p/15796265.html


# 目前还未实现的功能

1. 我们说一级缓存是应用内缓存，那么当你的项目部署在多个节点的时候，如何保证当你对某个key进行修改删除操作时，使其它节点的一级缓存一致呢？
采用哪种通信方式，我们是采用 redisson 的，还是用自己的 rpc 框架？


3. 指标数据采用数据上报还是采用查询的方式，目前还在思考中







































